# 换电站管理系统 - 阿里云部署指南

## 项目概述

本项目是一个基于 Vue 3 + Express.js 的换电站管理系统，包含前端 Web 应用和后端 API 服务。

## 部署架构

```
阿里云 ECS 服务器
├── Nginx (反向代理)
├── 前端静态文件 (Vue 3 构建产物)
└── 后端 API 服务 (Express.js + PM2)
```

## 部署步骤

### 1. 准备阿里云服务器

#### 1.1 购买 ECS 实例
- 推荐配置：2核4G内存，40G系统盘
- 操作系统：Ubuntu 20.04 LTS 或 CentOS 7/8
- 网络：分配公网IP

#### 1.2 安全组配置
开放以下端口：
- 22 (SSH)
- 80 (HTTP)
- 443 (HTTPS)
- 3001 (后端API，可选)

### 2. 服务器环境准备

#### 2.1 连接服务器
```bash
ssh root@your-server-ip
```

#### 2.2 更新系统
```bash
# Ubuntu
sudo apt update && sudo apt upgrade -y

# CentOS
sudo yum update -y
```

#### 2.3 安装 Node.js
```bash
# 安装 Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version
npm --version
```

#### 2.4 安装 Nginx
```bash
# Ubuntu
sudo apt install nginx -y

# CentOS
sudo yum install nginx -y

# 启动并设置开机自启
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 2.5 安装 PM2
```bash
npm install -g pm2
```

### 3. 部署后端服务

#### 3.1 创建项目目录
```bash
sudo mkdir -p /var/www/charging-station
cd /var/www/charging-station
```

#### 3.2 上传后端代码
将 `server` 目录上传到服务器：
```bash
# 方式1：使用 scp
scp -r ./server root@your-server-ip:/var/www/charging-station/

# 方式2：使用 git (推荐)
git clone your-repository-url .
```

#### 3.3 安装依赖
```bash
cd /var/www/charging-station/server
npm install --production
```

#### 3.4 配置环境变量
创建生产环境配置文件：
```bash
cp .env.example .env
vim .env
```

修改 `.env` 文件：
```env
# 服务端口
PORT=3001

# 数据存储目录
DATA_DIR="/var/www/charging-station/data"

# 数据库文件名
DB_FILE="battery-swap-station-data.json"

# 图片存储目录
PICTURES_DIR="/pictures"

# 最大JSON文件大小 (单位: MB)
MAX_FILE_SIZE=5

# 日志级别
LOG_LEVEL="info"
```

#### 3.5 创建数据目录
```bash
sudo mkdir -p /var/www/charging-station/data/pictures
sudo chown -R www-data:www-data /var/www/charging-station/data
```

#### 3.6 使用 PM2 启动服务
```bash
# 创建 PM2 配置文件
cat > ecosystem.config.js << EOF
module.exports = {
  apps: [{
    name: 'charging-station-api',
    script: 'app.js',
    cwd: '/var/www/charging-station/server',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3001
    },
    log_file: '/var/log/charging-station-api.log',
    error_file: '/var/log/charging-station-api-error.log',
    out_file: '/var/log/charging-station-api-out.log',
    time: true
  }]
};
EOF

# 启动服务
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save
```

### 4. 部署前端应用

#### 4.1 本地构建
在本地项目根目录执行：
```bash
# 修改生产环境配置
vim .env.pro
```

更新 `.env.pro` 文件中的 API 地址：
```env
# API 服务配置
VITE_API_BASE_URL=http://your-server-ip:3001/
VITE_API_URL=http://your-server-ip:3001

# 或者使用域名
# VITE_API_BASE_URL=https://api.yourdomain.com/
# VITE_API_URL=https://api.yourdomain.com
```

构建生产版本：
```bash
npm run build:pro
```

#### 4.2 上传构建文件
```bash
# 上传 dist 目录到服务器
scp -r ./dist root@your-server-ip:/var/www/charging-station/frontend
```

### 5. 配置 Nginx

#### 5.1 创建 Nginx 配置
```bash
sudo vim /etc/nginx/sites-available/charging-station
```

添加以下配置：
```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为你的域名或IP
    
    # 前端静态文件
    location / {
        root /var/www/charging-station/frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 缓存静态资源
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
    
    # API 代理
    location /api/ {
        proxy_pass http://localhost:3001/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 图片资源代理
    location /pictures/ {
        proxy_pass http://localhost:3001/pictures/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 5.2 启用站点
```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/charging-station /etc/nginx/sites-enabled/

# 测试配置
sudo nginx -t

# 重启 Nginx
sudo systemctl restart nginx
```

### 6. 配置 HTTPS (可选但推荐)

#### 6.1 安装 Certbot
```bash
sudo apt install certbot python3-certbot-nginx -y
```

#### 6.2 获取 SSL 证书
```bash
sudo certbot --nginx -d your-domain.com
```

### 7. 防火墙配置

```bash
# Ubuntu (UFW)
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw enable

# CentOS (firewalld)
sudo firewall-cmd --permanent --add-service=ssh
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 8. 监控和维护

#### 8.1 查看服务状态
```bash
# 查看 PM2 进程
pm2 status
pm2 logs

# 查看 Nginx 状态
sudo systemctl status nginx

# 查看系统资源
htop
df -h
```

#### 8.2 日志管理
```bash
# 查看应用日志
pm2 logs charging-station-api

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

#### 8.3 备份数据
```bash
# 创建备份脚本
cat > /var/www/charging-station/backup.sh << EOF
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/var/backups/charging-station"
mkdir -p $BACKUP_DIR

# 备份数据文件
cp -r /var/www/charging-station/data $BACKUP_DIR/data_$DATE

# 删除7天前的备份
find $BACKUP_DIR -name "data_*" -mtime +7 -exec rm -rf {} \;
EOF

chmod +x /var/www/charging-station/backup.sh

# 添加到定时任务
echo "0 2 * * * /var/www/charging-station/backup.sh" | sudo crontab -
```

## 更新部署

### 更新后端
```bash
cd /var/www/charging-station
git pull origin main
cd server
npm install --production
pm2 restart charging-station-api
```

### 更新前端
```bash
# 本地构建
npm run build:pro

# 上传到服务器
scp -r ./dist/* root@your-server-ip:/var/www/charging-station/frontend/
```

## 故障排除

### 常见问题

1. **API 请求失败**
   - 检查后端服务是否运行：`pm2 status`
   - 检查端口是否开放：`netstat -tlnp | grep 3001`
   - 查看应用日志：`pm2 logs`

2. **前端页面无法访问**
   - 检查 Nginx 状态：`sudo systemctl status nginx`
   - 检查配置文件：`sudo nginx -t`
   - 查看错误日志：`sudo tail -f /var/log/nginx/error.log`

3. **图片无法显示**
   - 检查图片目录权限：`ls -la /var/www/charging-station/data/pictures`
   - 检查 Nginx 代理配置

4. **高德地图无法加载**
   - 确认域名已在高德开放平台配置
   - 检查 API Key 是否正确

## 性能优化建议

1. **启用 Gzip 压缩**
2. **配置 CDN 加速**
3. **数据库优化**（如需要可升级到 MySQL/PostgreSQL）
4. **监控告警**（推荐使用阿里云监控）

## 安全建议

1. **定期更新系统和依赖**
2. **配置防火墙规则**
3. **使用 HTTPS**
4. **定期备份数据**
5. **监控异常访问**

---

部署完成后，你可以通过 `http://your-server-ip` 或 `https://your-domain.com` 访问换电站管理系统。